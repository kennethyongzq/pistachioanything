<!doctype html>
<html>

<head>
  <title>Test</title>
  <!-- Include Ecwid JS SDK -->
  <script src="https://djqizrxa6f10j.cloudfront.net/ecwid-sdk/js/1.2.8/ecwid-app.js"></script>

  <script>
    // Initialize the application
    EcwidApp.init({
      app_id: "custom-app-33883008-3", // your client_id
      autoloadedflag: true, 
      autoheight: true
    });

    // Get the store ID and access token
    var storeData = EcwidApp.getPayload();
    var storeId = storeData.store_id;
    var accessToken = storeData.access_token;
    var language = storeData.lang;

    if (storeData.public_token !== undefined){
      var publicToken = storeData.public_token;
    }
    
    if (storeData.app_state !== undefined){
      var appState = storeData.app_state;
    }

    // do something...
  </script>
  <!-- Jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css">
  <!-- Include Ecwid CSS Framework -->
  <link rel="stylesheet" href="https://d35z3p2poghz10.cloudfront.net/ecwid-sdk/css/1.3.13/ecwid-app-ui.css"/>  
</head>

<body class='normalized'>
<div>
	<div class="a-card a-card--normal">
		<div class="a-card__paddings">
			<div class="form-area">
				<div class="form-area__title form-area__title--small">Date changer2</div>
				<div class="form-area__content">
					<p>Please key in the order number to change the delivery date, do not use for self pickup orders</p>
					<div class="fieldsets-batch">
						<div class="fieldset">
							<div class="field field--medium">
								<label class="field__label">Order Number</label>
								<input id="order_no" type="number" class="field__input" tabindex="4" maxlength="64">
								<div class="field__placeholder">Order Number</div>
							</div>
						</div>
						<div class="fieldset">
							<div class="field field--medium">
								<label class="field__label">Date</label>
								<input id="order_date" type="text" class="field__input" tabindex="4" maxlength="64">
								<div class="field__placeholder">Date</div>
							</div>
						</div>

					</div>
				</div>
				<div class="form-area__action">
					<button type="button" onclick="onSaveClick()" class="btn btn-primary btn-medium">Save</button>
				</div>
				<h5>Log:</h5>
				<p id="krstest"></p>
			</div>
		</div>
	</div>
</div>

<!-- JS for CSS Framework components -->
  <script src="https://d35z3p2poghz10.cloudfront.net/ecwid-sdk/css/1.3.13/ecwid-app-ui.min.js"></script>
<script>
	$(document).ready(function(){
		$( "#order_date" ).datepicker({dateFormat: "dd M yy"});
	//		EcwidApp.setAppPublicConfig("Helloworld", function(){
	//		krslog("setAppPublicConfig Success");
	//	});
		var test_get = Ecwid.getAppPublicConfig('custom-app-33883008-3'); 
		krslog(test_get);
	});
	function krslog(text){
	        $("#krstest").append("<br />" + text);
	}
	function onSaveClick(){
		//$("#krstest").text($("#order_no").val());	
		var order_no = $("#order_no").val();
		if (order_no == ""){
			krslog("Error:Order No is empty");
			return;	
		}
		krslog("Order No = " + order_no);
		var order_date_text = $("#order_date").val();
		if (order_date_text == ""){
			krslog("Error:Date is empty");
			return;	
		}

		var jsDate = $('#order_date').datepicker('getDate');
		if (jsDate !== null) { // if any date selected in datepicker
		    if (jsDate instanceof Date){// -> true
		        krslog("Updating with Date = " + jsDate);	 
		    }
		    else{
		        krslog("Error:jsDate is not Date Instance");	    
		    }
		}
		else{
    		    krslog("Error:Date is null");
		}
		
		var xhttp = new XMLHttpRequest();

		var requestURL = "https://app.ecwid.com/api/v3/"+storeId+"/orders/"+order_no+"?token="+accessToken
		krslog("GET:requestURL:" + requestURL);
		xhttp.open("GET", requestURL, true);
		xhttp.send();

		xhttp.onreadystatechange = function() {
		  
		  krslog("xhttp.readyState = " + xhttp.readyState);
		  krslog("xhttp.status = " + xhttp.status);
		  if (xhttp.readyState == 4 && xhttp.status == 200) {
		    var apiResponse = xhttp.responseText;
		    var my_order = JSON.parse(apiResponse);
		    krslog("Success: GET success ID = " + my_order.id);

		    var time_end = my_order.extraFields.ecwid_order_delivery_time_interval_end;	
		    var time_format = my_order.extraFields.ecwid_order_delivery_time_display_format;
		    var time_start = my_order.extraFields.ecwid_order_delivery_time_interval_start;

	            if (time_end !== undefined && time_start !== undefined){			    
		      var yst = new Date(jsDate.getTime());

		      yst.setDate(yst.getDate() - 1);

		      //var updated_time_start = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate(), 00, 0, 0, 0);
		      //var updated_time_end = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate(), 23, 59, 0, 0);
		      var updated_time_start = yst.getFullYear() + "-" + String(yst.getMonth()+1).padStart(2, '0') + "-" + String(yst.getDate()).padStart(2, '0') + " 16:00:00 +0000"
		      var updated_time_end = jsDate.getFullYear() + "-" + String(jsDate.getMonth()+1).padStart(2, '0') + "-" + String(jsDate.getDate()).padStart(2, '0') + " 15:59:59 +0000"

  		      krslog("Original: Time End = " + time_end);
		      krslog("Original: Time Start = " + time_start);
  		      krslog("Update: Time End = " + updated_time_end);
		      krslog("Update: Time Start = " + updated_time_start);
		      my_order.extraFields.ecwid_order_delivery_time_interval_end = updated_time_end;
		      my_order.extraFields.ecwid_order_delivery_time_interval_start = updated_time_start;	    
		      // Begin PUT
			    
						var xhttp2 = new XMLHttpRequest();
								 
						krslog("PUT:requestURL:" + requestURL);
						xhttp2.open("PUT", requestURL, true);
		   			        xhttp2.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
			    			//var to_send = {'extraFields':{'ecwid_order_delivery_time_interval_end':updated_time_end,
						//			     'ecwid_order_delivery_time_interval_start':updated_time_start}};
			    			var to_send ={"extraFields": {
									 "ecwid_order_delivery_time_interval_end": updated_time_end,
									 "ecwid_order_delivery_time_display_format": "DATE",
									 "ecwid_order_delivery_time_interval_start": updated_time_start,
									     },
									 "orderExtraFields": [
									       {
									 "id": "ecwid_order_delivery_time_interval_end",
									 "value": updated_time_end,
									 "customerInputType": "DATETIME",
									 "title": "",
									 "orderDetailsDisplaySection": "",
									 "orderBy": "0"
									       },
									       {
									 "id": "ecwid_order_delivery_time_display_format",
									 "value": "DATE",
									 "customerInputType": "TEXT",
									 "title": "",
									 "orderDetailsDisplaySection": "",
									 "orderBy": "0"
									       },
									       {
									 "id": "ecwid_order_delivery_time_interval_start",
									 "value": updated_time_start,
									 "customerInputType": "DATETIME",
									 "title": "Delivery date and time",
									 "orderDetailsDisplaySection": "shipping_info",
									 "orderBy": "1"
										   }
									       ]
									}
			    			var stringified_to_send = JSON.stringify(to_send)
						krslog(stringified_to_send);
						xhttp2.send(stringified_to_send);

						xhttp2.onreadystatechange = function() {

						  krslog("xhttp2.readyState = " + xhttp2.readyState);
						  krslog("xhttp2.status = " + xhttp2.status);
						  if (xhttp2.readyState == 4 && xhttp2.status == 200) {
						    var apiResponse2 = xhttp2.responseText;
						    var return_from_put = JSON.parse(apiResponse2);
						    krslog("Success: PUT Success Update Count = " + return_from_put.updateCount);
						  }
						};    
			    
     		      // End PUT
		    }
		    else{
		      krslog("Order is not a delivery");
		      return;
		    }
		  }
		};


	}
	
	

	</script>
</body>

</html>
